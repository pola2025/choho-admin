<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ˆí˜¸íœì…˜ ì˜ˆì•½ ê´€ë¦¬ ì‹œìŠ¤í…œ v2.0</title>
    <!-- FullCalendar ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <style>
        :root {
            --primary-color: #2d5016;
            --secondary-color: #558b2f;
            --accent-green: #27ae60;
            --light-gray: #f5f5f5;
            --dark-text: #333;
            --light-text: #666;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); color: var(--dark-text); }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-box h1 { text-align: center; color: var(--primary-color); margin-bottom: 30px; }
        .login-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; }
        .login-button { width: 100%; padding: 12px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .login-button:hover { background: #2ecc71; }
        .dashboard { display: none; min-height: 100vh; background: var(--light-gray); }
        .header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; color: var(--primary-color); }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .sync-status { display: flex; align-items: center; gap: 5px; font-size: 12px; color: var(--light-text); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .logout-btn { padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .stats-container { padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .stat-card h3 { font-size: 14px; color: var(--light-text); margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary-color); }
        .stat-card.accent-yellow { border-left: 4px solid #f39c12; }
        .stat-card.accent-green { border-left: 4px solid var(--accent-green); }
        .stat-card.accent-blue { border-left: 4px solid #3498db; }
        .stat-card.accent-purple { border-left: 4px solid #9b59b6; }
        .tabs { background: white; border-bottom: 1px solid #e0e0e0; position: sticky; top: 60px; z-index: 90; }
        .tabs-content { display: flex; padding: 0 20px; overflow-x: auto;}
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; position: relative; white-space: nowrap; }
        .tab.active { color: var(--accent-green); border-bottom-color: var(--accent-green); background: #f0f8f0; }
        .tab-badge { position: absolute; top: 8px; right: 8px; background: #e74c3c; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
        .content { padding: 20px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .reservations-container { display: grid; gap: 15px; }
        .reservation-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor:pointer; }
        .reservation-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .reservation-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .reservation-body { padding: 20px; }
        .customer-info { margin-bottom: 15px; }
        .customer-name { font-size: 18px; font-weight: 600; color: var(--primary-color); margin-bottom: 5px; }
        .customer-contact { font-size: 14px; color: var(--light-text); line-height: 1.5; }
        .reservation-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
        .detail-item { background: #f8f9fa; padding: 12px; border-radius: 8px; }
        .detail-label { font-size: 12px; color: var(--light-text); margin-bottom: 4px; }
        .detail-value { font-size: 14px; font-weight: 600; color: var(--dark-text); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-checked-in { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .rooms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .room-card { background: white; border-radius: 12px; padding: 20px; border: 2px solid #e0e0e0; text-align: center; cursor: pointer; transition: all 0.3s; }
        .room-card.occupied { background: #ffe5e5; border-color: #ffb3b3; }
        .room-card.available { background: #e5ffe5; border-color: #b3ffb3; }
        .room-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .room-number { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .room-type { font-size: 14px; color: var(--light-text); margin-bottom: 12px; }
        .room-status { font-size: 14px; font-weight: 600; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .floating-add-btn { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--accent-green); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; z-index: 50; }
        .floating-add-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-bar { background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .filter-item { display: flex; align-items: center; gap: 8px; }
        .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-input { width: 100%; padding: 8px 12px 8px 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--light-text); }
        #calendar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .fc-event { cursor: pointer; border: none !important; padding: 5px; }
        .fc-event-main { font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .price-summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #e0e0e0; }
        .price-summary h4 { margin-bottom: 10px; font-size: 16px; color: var(--primary-color); }
        .price-item { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .price-total { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-weight: bold; font-size: 18px; color: var(--accent-green); }
        .no-reservations { text-align: center; padding: 50px; background: white; border-radius: 12px; color: var(--light-text); }
        @media (max-width: 768px) {
            .stats-container { grid-template-columns: 1fr; }
            .reservation-details { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .search-box { width: 100%; }
            .header h1 { font-size: 16px; }
            .sync-status { display: none; }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>ì´ˆí˜¸íœì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <input type="password" id="passwordInput" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button id="loginButton" class="login-button">ë¡œê·¸ì¸</button>
        </div>
    </div>
    
    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div class="header-content">
                <h1>ì´ˆí˜¸íœì…˜ ì˜ˆì•½ ê´€ë¦¬</h1>
                <div class="header-actions">
                    <div class="sync-status">
                        <div class="sync-dot"></div>
                        <span id="lastSync">ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘</span>
                    </div>
                    <button id="logoutButton" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
        <div class="stats-container">
            <div class="stat-card accent-yellow"><h3>ì „ì²´ ì˜ˆì•½</h3><div class="stat-value" id="totalReservations">0</div></div>
            <div class="stat-card accent-green"><h3>í™•ì • ì˜ˆì•½</h3><div class="stat-value" id="confirmedReservations">0</div></div>
            <div class="stat-card accent-blue"><h3>ì˜¤ëŠ˜ ì²´í¬ì¸</h3><div class="stat-value" id="todayCheckIn">0</div></div>
            <div class="stat-card accent-purple"><h3>ì´ë²ˆë‹¬ ë§¤ì¶œ</h3><div class="stat-value" id="monthlyRevenue">0ì›</div></div>
        </div>
        <div class="tabs">
            <div class="tabs-content">
                <div class="tab active" data-tab="reservations">ì˜ˆì•½ ê´€ë¦¬<span class="tab-badge" id="pendingBadge" style="display: none;">0</span></div>
                <div class="tab" data-tab="rooms">ê°ì‹¤ í˜„í™©</div>
                <div class="tab" data-tab="calendar">ìº˜ë¦°ë”</div>
            </div>
        </div>
        <div class="content">
            <div class="tab-content active" id="reservationsTab">
                <div class="filter-bar">
                    <div class="filter-item"><label>ìƒíƒœ:</label><select class="filter-select" id="statusFilter"><option value="all">ì „ì²´</option><option value="pending">ì…ê¸ˆëŒ€ê¸°</option><option value="confirmed">ì˜ˆì•½í™•ì •</option><option value="checked-in">ì²´í¬ì¸</option><option value="cancelled">ì·¨ì†Œ</option></select></div>
                    <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" id="searchInput" placeholder="ê³ ê°ëª…, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰"></div>
                </div>
                <div class="reservations-container" id="reservationsList"></div>
            </div>
            <div class="tab-content" id="roomsTab"><div class="rooms-grid" id="roomsList"></div></div>
            <div class="tab-content" id="calendarTab"><div id="calendar"></div></div>
        </div>
        <button id="addReservationButton" class="floating-add-btn">+</button>
    </div>
    
    <!-- ì˜ˆì•½ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle"></h2><button id="closeModalButton" style="background:none;border:none;font-size:24px;cursor:pointer;">Ã—</button></div>
            <div class="modal-body">
                <form id="reservationForm">
                    <div class="form-group"><label class="form-label">ê³ ê°ëª… *</label><input type="text" class="form-input" id="formCustomerName" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ì „í™”ë²ˆí˜¸ *</label><input type="tel" class="form-input" id="formPhone" required></div>
                        <div class="form-group"><label class="form-label">ì´ë©”ì¼</label><input type="email" class="form-input" id="formEmail"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ì²´í¬ì¸ *</label><input type="date" class="form-input" id="formCheckIn" required></div>
                        <div class="form-group"><label class="form-label">ì²´í¬ì•„ì›ƒ *</label><input type="date" class="form-input" id="formCheckOut" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ê°ì‹¤ íƒ€ì…</label><select class="form-input" id="formRoomType"><option value="í˜¸ìˆ˜ë·°ê°ì‹¤">í˜¸ìˆ˜ë·°ê°ì‹¤</option><option value="Forest">Forest</option><option value="Forest mini">Forest mini</option><option value="Forest íŒ¨ë°€ë¦¬ë£¸">Forest íŒ¨ë°€ë¦¬ë£¸</option><option value="Forest mini íŒ¨ë°€ë¦¬ë£¸">Forest mini íŒ¨ë°€ë¦¬ë£¸</option></select></div>
                        <div class="form-group"><label class="form-label">ì¸ì›</label><select class="form-input" id="formGuests"></select></div>
                    </div>
                    <div class="form-group"><label class="form-label"><input type="checkbox" id="formBbq"> ìˆ¯ë¶ˆ ë°”ë² í (í˜„ì¥ ê²°ì œ)</label></div>
                    <div class="form-group"><label class="form-label">ìš”ì²­ì‚¬í•­</label><textarea class="form-input" id="formRequests" rows="3"></textarea></div>
                    <div class="price-summary">
                        <h4>ì˜ˆì•½ ê¸ˆì•¡</h4>
                        <div class="price-item"><span>ê°ì‹¤ ìš”ê¸ˆ</span><span id="summaryRoomRate">-</span></div>
                        <div class="price-item"><span>ì¶”ê°€ ì¸ì›</span><span id="summaryExtraPerson">-</span></div>
                        <div class="price-item"><span>ë°”ë² í</span><span id="summaryBbq">-</span></div>
                        <div class="price-item price-total"><span>ì´ ê¸ˆì•¡</span><span id="summaryTotal">-</span></div>
                    </div>
                    <input type="hidden" id="formAmount"><input type="hidden" id="formBbqCharge">
                    <div class="reservation-actions" style="margin-top: 20px;" id="modalActionButtons"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    
    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9Fav0VorRG1ukk1StToVuBoHrPvVw_sqUGZacSuBimPbbI3f54O5in00Y6-Z91AEhtQ/exec';
        const roomData = {
            'í˜¸ìˆ˜ë·°ê°ì‹¤': { basePrice: 150000, baseGuests: 2, maxGuests: 6, extraCharge: 15000 },
            'Forest': { basePrice: 180000, baseGuests: 2, maxGuests: 4, extraCharge: 15000 },
            'Forest mini': { basePrice: 150000, baseGuests: 2, maxGuests: 2, extraCharge: 0 },
            'Forest íŒ¨ë°€ë¦¬ë£¸': { basePrice: 200000, baseGuests: 4, maxGuests: 5, extraCharge: 15000 },
            'Forest mini íŒ¨ë°€ë¦¬ë£¸': { basePrice: 150000, baseGuests: 2, maxGuests: 3, extraCharge: 15000 }
        };
        const BBQ_PRICE = 30000;

        // --- GLOBAL VARIABLES ---
        let allReservations = [];
        let currentEditData = null; 
        let autoRefreshInterval = null;
        let sessionPassword = null;
        let calendar = null;
        let isCalendarRendered = false;

  // --- API COMMUNICATION (JSONP) ---
        function apiRequest(params) {
            return new Promise((resolve, reject) => {
                // [ìˆ˜ì •] ë¡œê·¸ì¸(checkPassword) ì•¡ì…˜ì´ ì•„ë‹ ë•Œë§Œ ë¹„ë°€ë²ˆí˜¸ ì¡´ì¬ ì—¬ë¶€ ê²€ì‚¬
                if (params.action !== 'checkPassword' && !sessionPassword) {
                    alert('ì¸ì¦ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    logout();
                    reject(new Error('No session password.'));
                    return;
                }

                const callbackName = 'jsonpCallback_' + Date.now() + Math.floor(Math.random() * 1000);
                
                // ë¡œê·¸ì¸ ì‹œì—ëŠ” í•¨ìˆ˜ ì¸ìë¡œ ë°›ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼, ê·¸ ì™¸ì—ëŠ” ì„¸ì…˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©
                params.password = params.action === 'checkPassword' ? params.password : sessionPassword;
                params.callback = callbackName;
                
                const queryString = Object.keys(params)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                    .join('&');
                
                window[callbackName] = function(data) {
                    if (data.success) {
                        resolve(data);
                    } else {
                        console.error('API Error:', data.error);
                        reject(new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜'));
                    }
                    try { delete window[callbackName]; document.body.removeChild(script); } catch (e) {}
                };

                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?${queryString}`;
                
                script.onerror = () => {
                    reject(new Error('Script loading failed.'));
                    try { delete window[callbackName]; document.body.removeChild(script); } catch (e) {}
                };
                
                document.body.appendChild(script);
            });
        }

        // --- AUTHENTICATION ---
                async function login() {
                const password = document.getElementById('passwordInput').value;
                if (!password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                
                showLoading();
                try {
                    // [ìˆ˜ì •] ëª¨ë“  ìš”ì²­ì„ ì¼ê´€ë˜ê²Œ apiRequestë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
                    const response = await apiRequest({
                        action: 'checkPassword',
                        password: password // apiRequest í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ìë™ìœ¼ë¡œ sessionPassword ëŒ€ì‹  ì´ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    });

                    if (response.success) {
                        sessionPassword = password;
                        sessionStorage.setItem('chohoAdminToken', password);
                        showDashboard();
                    } else {
                        // ì„œë²„ì—ì„œ ë³´ë‚´ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ í‘œì‹œ, ì—†ë‹¤ë©´ ê¸°ë³¸ ë©”ì‹œì§€
                        alert(response.error || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                } catch(error) {
                    console.error('Login error:', error);
                    alert(`ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }
        function logout() { sessionPassword = null; sessionStorage.removeItem('chohoAdminToken'); location.reload(); }
        function showDashboard() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; loadInitialData(); startAutoRefresh(); }
        
        // --- UTILITY ---
        function sanitizeHTML(str) { if (!str) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function formatDate(dateStr) { if (!dateStr) return ''; const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()} (${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]})`; }
        function getStatusText(s) { return { pending: 'ì…ê¸ˆëŒ€ê¸°', confirmed: 'ì˜ˆì•½í™•ì •', 'checked-in': 'ì²´í¬ì¸', 'checked-out':'ì²´í¬ì•„ì›ƒ', cancelled: 'ì·¨ì†Œ' }[s] || 'ì•Œ ìˆ˜ ì—†ìŒ'; }
        
        // --- DATA HANDLING & UI ---
        async function loadInitialData() {
            showLoading();
            try {
                await Promise.all([loadReservations(), updateDashboard()]);
                const now = new Date(); document.getElementById('lastSync').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                if (isCalendarRendered) renderCalendar();
            } catch (error) { alert(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
        }
        async function loadReservations() {
            const result = await apiRequest({ action: 'getReservations' });
            if (result.success) { allReservations = result.data; displayReservations(); updateRoomStatus(); }
        }
        async function updateDashboard() {
            const result = await apiRequest({ action: 'getDashboardStats' });
            if (result.success) {
                const s = result.data;
                document.getElementById('totalReservations').textContent = s.totalReservations;
                document.getElementById('confirmedReservations').textContent = s.confirmedReservations;
                document.getElementById('todayCheckIn').textContent = s.todayCheckIn;
                document.getElementById('monthlyRevenue').textContent = s.monthlyRevenue.toLocaleString() + 'ì›';
                const badge = document.getElementById('pendingBadge');
                if (s.pendingReservations > 0) { badge.textContent = s.pendingReservations; badge.style.display = 'block'; } else { badge.style.display = 'none'; }
            }
        }
        function displayReservations() {
            const container = document.getElementById('reservationsList');
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allReservations.filter(r => (statusFilter === 'all' || r.status === statusFilter) && ((r.customerName||'').toLowerCase().includes(searchTerm) || (r.phone||'').includes(searchTerm)));
            if (filtered.length === 0) { container.innerHTML = `<div class="no-reservations"><h3>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</h3><p>í•„í„° ì¡°ê±´ì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆ ì˜ˆì•½ì„ ì¶”ê°€í•˜ì„¸ìš”.</p></div>`; return; }
            container.innerHTML = filtered.map(res => `
                <div class="reservation-card" onclick="editReservation('${res.bookingId || res.id}')">
                    <div class="reservation-header"><span style="font-weight:600;">#${sanitizeHTML(res.bookingId || res.id)}</span><span class="status-badge status-${res.status}">${getStatusText(res.status)}</span></div>
                    <div class="reservation-body">
                        <div class="customer-info"><div class="customer-name">${sanitizeHTML(res.customerName)}</div><div class="customer-contact">ğŸ“ ${sanitizeHTML(res.phone)}</div></div>
                        <div class="reservation-details">
                            <div class="detail-item"><div class="detail-label">ì²´í¬ì¸</div><div class="detail-value">${formatDate(res.checkIn)}</div></div>
                            <div class="detail-item"><div class="detail-label">ì²´í¬ì•„ì›ƒ</div><div class="detail-value">${formatDate(res.checkOut)}</div></div>
                            <div class="detail-item"><div class="detail-label">ê°ì‹¤</div><div class="detail-value">${sanitizeHTML(res.roomName)}</div></div>
                            <div class="detail-item"><div class="detail-label">ì¸ì›</div><div class="detail-value">${res.guests}ëª…</div></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function updateRoomStatus() { /* ìƒëµ */ }
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            const events = allReservations.filter(r => r.status !== 'cancelled').map(r => ({
                title: `${r.roomName.replace('ê°ì‹¤','').replace('íŒ¨ë°€ë¦¬ë£¸','F')} - ${r.customerName}`, start: r.checkIn, end: r.checkOut,
                extendedProps: { reservation: r },
                backgroundColor: {confirmed:'#27ae60', 'checked-in':'#3498db', pending:'#f39c12'}[r.status],
            }));
            if (calendar) { calendar.destroy(); }
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                events: events, eventClick: (info) => editReservation(info.event.extendedProps.reservation.bookingId || info.event.extendedProps.reservation.id)
            });
            calendar.render(); isCalendarRendered = true;
        }

        // --- ACTIONS & MODAL ---
        function startAutoRefresh() { if (autoRefreshInterval) clearInterval(autoRefreshInterval); autoRefreshInterval = setInterval(loadInitialData, 30000); }
        async function updateReservationAction(rowIndex, updates, successMsg) {
            showLoading();
            try {
                await apiRequest({ action: 'updateReservation', rowIndex: rowIndex, updates: JSON.stringify(updates) });
                alert(successMsg);
                closeModal(); await loadInitialData();
            } catch (error) { alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
        }
        function showAddReservationModal() {
            currentEditData = null;
            document.getElementById('modalTitle').textContent = 'ìƒˆ ì˜ˆì•½ ì¶”ê°€';
            document.getElementById('reservationForm').reset();
            populateGuestOptions(document.getElementById('formRoomType').value); updatePriceSummary();
            document.getElementById('modalActionButtons').innerHTML = `<button type="button" id="saveReservationButton" class="action-btn btn-success" style="flex:1;">ì €ì¥</button>`;
            document.getElementById('saveReservationButton').addEventListener('click', saveReservation);
            document.getElementById('reservationModal').classList.add('active');
        }
        function editReservation(id) {
            const reservation = allReservations.find(r => (r.bookingId || r.id) === id); if (!reservation) { alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            currentEditData = reservation; document.getElementById('modalTitle').textContent = 'ì˜ˆì•½ ì •ë³´ ìˆ˜ì •';
            populateGuestOptions(reservation.roomName);
            document.getElementById('formCustomerName').value = reservation.customerName; document.getElementById('formPhone').value = reservation.phone; document.getElementById('formEmail').value = reservation.email || '';
            document.getElementById('formCheckIn').value = reservation.checkIn; document.getElementById('formCheckOut').value = reservation.checkOut;
            document.getElementById('formRoomType').value = reservation.roomName; document.getElementById('formGuests').value = reservation.guests;
            document.getElementById('formBbq').checked = (reservation.bbqCharge > 0); document.getElementById('formRequests').value = reservation.requests || '';
            updatePriceSummary();
            
            const actionButtons = document.getElementById('modalActionButtons');
            let buttonsHTML = `<button type="button" id="saveReservationButton" class="action-btn btn-success" style="flex:1;">ìˆ˜ì • ì €ì¥</button>`;
            if (reservation.status === 'pending' && !reservation.depositConfirmed) { buttonsHTML += `<button type="button" id="confirmDepositBtn" class="action-btn btn-primary">ì…ê¸ˆí™•ì¸</button>`; }
            if (reservation.status !== 'cancelled') { buttonsHTML += `<button type="button" id="cancelReservationBtn" class="action-btn btn-danger">ì˜ˆì•½ì·¨ì†Œ</button>`;}
            actionButtons.innerHTML = buttonsHTML;
            
            document.getElementById('saveReservationButton').addEventListener('click', saveReservation);
            if(document.getElementById('confirmDepositBtn')) document.getElementById('confirmDepositBtn').addEventListener('click', () => updateReservationAction(currentEditData.rowIndex, { depositConfirmed: true }, 'ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'));
            if(document.getElementById('cancelReservationBtn')) document.getElementById('cancelReservationBtn').addEventListener('click', () => updateReservationAction(currentEditData.rowIndex, { status: 'cancelled' }, 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'));
            
            document.getElementById('reservationModal').classList.add('active');
        }
        function closeModal() { document.getElementById('reservationModal').classList.remove('active'); }
        async function saveReservation() {
            const formData = {
                customerName: document.getElementById('formCustomerName').value, phone: document.getElementById('formPhone').value, email: document.getElementById('formEmail').value,
                checkIn: document.getElementById('formCheckIn').value, checkOut: document.getElementById('formCheckOut').value, roomName: document.getElementById('formRoomType').value,
                guests: parseInt(document.getElementById('formGuests').value), requests: document.getElementById('formRequests').value,
                totalAmount: parseInt(document.getElementById('formAmount').value), bbqCharge: parseInt(document.getElementById('formBbqCharge').value) || 0
            };
            if (!formData.customerName || !formData.phone || !formData.checkIn || !formData.checkOut) { alert('í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if(currentEditData) {
                updateReservationAction(currentEditData.rowIndex, formData, 'ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                formData.status = 'confirmed'; formData.depositConfirmed = true;
                showLoading();
                try {
                    await apiRequest({ action: 'addReservation', data: JSON.stringify(formData) });
                    alert('ì˜ˆì•½ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal(); await loadInitialData();
                } catch(error) { alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
            }
        }
        function updatePriceSummary() {
            const roomName = document.getElementById('formRoomType').value; const checkIn = document.getElementById('formCheckIn').value; const checkOut = document.getElementById('formCheckOut').value;
            const guests = parseInt(document.getElementById('formGuests').value || 0); const bbqChecked = document.getElementById('formBbq').checked; const room = roomData[roomName]; if (!room || !checkIn || !checkOut) return;
            const nights = Math.max(1, Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24)));
            const roomRate = room.basePrice * nights; const extraGuests = Math.max(0, guests - room.baseGuests);
            const extraPersonCharge = extraGuests * room.extraCharge * nights; const bbqCharge = bbqChecked ? BBQ_PRICE : 0;
            const totalAmount = roomRate + extraPersonCharge;
            document.getElementById('summaryRoomRate').textContent = `${roomRate.toLocaleString()}ì› (${nights}ë°•)`;
            document.getElementById('summaryExtraPerson').textContent = `${extraPersonCharge.toLocaleString()}ì› (${extraGuests}ëª…)`;
            document.getElementById('summaryBbq').textContent = `${bbqCharge.toLocaleString()}ì› (í˜„ì¥ê²°ì œ)`;
            document.getElementById('summaryTotal').textContent = `${totalAmount.toLocaleString()}ì›`;
            document.getElementById('formAmount').value = totalAmount; document.getElementById('formBbqCharge').value = bbqCharge;
        }
        function populateGuestOptions(roomName) {
            const room = roomData[roomName]; if(!room) return;
            const guestSelect = document.getElementById('formGuests'); guestSelect.innerHTML = '';
            for (let i = 1; i <= room.maxGuests; i++) { const option = document.createElement('option'); option.value = i; option.textContent = `${i}ëª…`; guestSelect.appendChild(option); }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('passwordInput').addEventListener('keyup', e => { if (e.key === 'Enter') login(); });
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('addReservationButton').addEventListener('click', showAddReservationModal);
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            document.getElementById('cancelModalButton').addEventListener('click', closeModal); // ëª¨ë‹¬ ì•ˆ ì·¨ì†Œë²„íŠ¼
            document.getElementById('statusFilter').addEventListener('change', displayReservations);
            document.getElementById('searchInput').addEventListener('keyup', displayReservations);
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', e => {
                document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                const tabName = e.currentTarget.dataset.tab; e.currentTarget.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
                if (tabName === 'calendar' && !isCalendarRendered) renderCalendar();
            }));
            ['formCheckIn', 'formCheckOut', 'formRoomType', 'formGuests', 'formBbq'].forEach(id => document.getElementById(id).addEventListener('change', updatePriceSummary));
            document.getElementById('formRoomType').addEventListener('change', e => populateGuestOptions(e.target.value));
            populateGuestOptions(document.getElementById('formRoomType').value);
            if (sessionStorage.getItem('chohoAdminToken')) { sessionPassword = sessionStorage.getItem('chohoAdminToken'); showDashboard(); }
        });
    </script>
</body>
</html>
