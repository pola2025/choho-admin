<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ˆí˜¸íœì…˜ ì˜ˆì•½ ê´€ë¦¬ ì‹œìŠ¤í…œ v2.0</title>
    <!-- FullCalendar ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <style>
        /* ì „ì²´ì ì¸ CSSëŠ” ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. */
        :root {
            --primary-color: #2d5016;
            --secondary-color: #558b2f;
            --accent-green: #27ae60;
            --light-gray: #f5f5f5;
            --dark-text: #333;
            --light-text: #666;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); color: var(--dark-text); }
        /* ... (ì´ì „ CSS ì½”ë“œì™€ ë™ì¼) ... */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .login-box h1 { color: var(--primary-color); }
        .login-button { background: var(--accent-green); }
        .header h1 { color: var(--primary-color); }
        .stat-value { color: var(--primary-color); }
        .tab.active { color: var(--accent-green); border-bottom-color: var(--accent-green); }
        .customer-name { color: var(--primary-color); }
        .floating-add-btn { background: var(--accent-green); }
        .spinner { border-top-color: var(--accent-green); }

        /* ìº˜ë¦°ë” UI ê°œì„  */
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .fc-event {
            cursor: pointer;
            border: none !important;
            padding: 5px;
        }
        .fc-event-main {
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ì˜ˆì•½ ê¸ˆì•¡ ìš”ì•½ UI */
        .price-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
        }
        .price-summary h4 {
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--primary-color);
        }
        .price-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .price-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-weight: bold;
            font-size: 18px;
            color: var(--accent-green);
        }
        .no-reservations {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 12px;
            color: var(--light-text);
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>ì´ˆí˜¸íœì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <input type="password" id="passwordInput" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button id="loginButton" class="login-button">ë¡œê·¸ì¸</button>
        </div>
    </div>
    
    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div class="dashboard" id="dashboard">
        <!-- í—¤ë” ë° í†µê³„ (ì´ì „ê³¼ ë™ì¼) -->
        <div class="header">
             <div class="header-content">
                <h1>ì´ˆí˜¸íœì…˜ ì˜ˆì•½ ê´€ë¦¬</h1>
                <div class="header-actions">
                    <div class="sync-status">
                        <div class="sync-dot"></div>
                        <span id="lastSync">ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘</span>
                    </div>
                    <button id="logoutButton" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
        <div class="stats-container">
            <div class="stat-card accent-yellow"><h3>ì „ì²´ ì˜ˆì•½</h3><div class="stat-value" id="totalReservations">0</div></div>
            <div class="stat-card accent-green"><h3>í™•ì • ì˜ˆì•½</h3><div class="stat-value" id="confirmedReservations">0</div></div>
            <div class="stat-card accent-blue"><h3>ì˜¤ëŠ˜ ì²´í¬ì¸</h3><div class="stat-value" id="todayCheckIn">0</div></div>
            <div class="stat-card accent-purple"><h3>ì´ë²ˆë‹¬ ë§¤ì¶œ</h3><div class="stat-value" id="monthlyRevenue">0ì›</div></div>
        </div>
        
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tabs">
            <div class="tabs-content">
                <div class="tab active" data-tab="reservations">ì˜ˆì•½ ê´€ë¦¬<span class="tab-badge" id="pendingBadge" style="display: none;">0</span></div>
                <div class="tab" data-tab="rooms">ê°ì‹¤ í˜„í™©</div>
                <div class="tab" data-tab="calendar">ìº˜ë¦°ë”</div>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="content">
            <div class="tab-content active" id="reservationsTab">
                <div class="filter-bar">
                    <div class="filter-item"><label>ìƒíƒœ:</label><select class="filter-select" id="statusFilter"><option value="all">ì „ì²´</option><option value="pending">ì…ê¸ˆëŒ€ê¸°</option><option value="confirmed">ì˜ˆì•½í™•ì •</option><option value="checked-in">ì²´í¬ì¸</option><option value="cancelled">ì·¨ì†Œ</option></select></div>
                    <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" id="searchInput" placeholder="ê³ ê°ëª…, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰"></div>
                </div>
                <div class="reservations-container" id="reservationsList"></div>
            </div>
            <div class="tab-content" id="roomsTab"><div class="rooms-grid" id="roomsList"></div></div>
            <div class="tab-content" id="calendarTab"><div id="calendar"></div></div>
        </div>
        
        <button id="addReservationButton" class="floating-add-btn">+</button>
    </div>
    
    <!-- ì˜ˆì•½ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle"></h2><button id="closeModalButton" style="background:none;border:none;font-size:24px;cursor:pointer;">Ã—</button></div>
            <div class="modal-body">
                <form id="reservationForm">
                    <div class="form-group"><label class="form-label">ê³ ê°ëª… *</label><input type="text" class="form-input" id="formCustomerName" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ì „í™”ë²ˆí˜¸ *</label><input type="tel" class="form-input" id="formPhone" required></div>
                        <div class="form-group"><label class="form-label">ì´ë©”ì¼</label><input type="email" class="form-input" id="formEmail"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ì²´í¬ì¸ *</label><input type="date" class="form-input" id="formCheckIn" required></div>
                        <div class="form-group"><label class="form-label">ì²´í¬ì•„ì›ƒ *</label><input type="date" class="form-input" id="formCheckOut" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ê°ì‹¤ íƒ€ì…</label><select class="form-input" id="formRoomType"><option value="í˜¸ìˆ˜ë·°ê°ì‹¤">í˜¸ìˆ˜ë·°ê°ì‹¤</option><option value="Forest">Forest</option><option value="Forest mini">Forest mini</option><option value="Forest íŒ¨ë°€ë¦¬ë£¸">Forest íŒ¨ë°€ë¦¬ë£¸</option><option value="Forest mini íŒ¨ë°€ë¦¬ë£¸">Forest mini íŒ¨ë°€ë¦¬ë£¸</option></select></div>
                        <div class="form-group"><label class="form-label">ì¸ì›</label><select class="form-input" id="formGuests"></select></div>
                    </div>
                    <div class="form-group"><label class="form-label"><input type="checkbox" id="formBbq"> ìˆ¯ë¶ˆ ë°”ë² í (í˜„ì¥ ê²°ì œ)</label></div>
                    <div class="form-group"><label class="form-label">ìš”ì²­ì‚¬í•­</label><textarea class="form-input" id="formRequests" rows="3"></textarea></div>
                    
                    <!-- ì˜ˆì•½ ê¸ˆì•¡ ìš”ì•½ -->
                    <div class="price-summary">
                        <h4>ì˜ˆì•½ ê¸ˆì•¡</h4>
                        <div class="price-item"><span>ê°ì‹¤ ìš”ê¸ˆ</span><span id="summaryRoomRate">-</span></div>
                        <div class="price-item"><span>ì¶”ê°€ ì¸ì›</span><span id="summaryExtraPerson">-</span></div>
                        <div class="price-item"><span>ë°”ë² í</span><span id="summaryBbq">-</span></div>
                        <div class="price-item price-total"><span>ì´ ê¸ˆì•¡</span><span id="summaryTotal">-</span></div>
                    </div>
                    <input type="hidden" id="formAmount"><input type="hidden" id="formBbqCharge">
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" id="cancelModalButton" class="action-btn btn-secondary" style="flex:1;">ì·¨ì†Œ</button>
                        <button type="button" id="saveReservationButton" class="action-btn btn-success" style="flex:1;">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    
    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9Fav0VorRG1ukk1StToVuBoHrPvVw_sqUGZacSuBimPbbI3f54O5in00Y6-Z91AEhtQ/exec';
        const roomData = {
            'í˜¸ìˆ˜ë·°ê°ì‹¤': { basePrice: 150000, baseGuests: 2, maxGuests: 6, extraCharge: 15000 },
            'Forest': { basePrice: 180000, baseGuests: 2, maxGuests: 4, extraCharge: 15000 },
            'Forest mini': { basePrice: 150000, baseGuests: 2, maxGuests: 2, extraCharge: 0 },
            'Forest íŒ¨ë°€ë¦¬ë£¸': { basePrice: 200000, baseGuests: 4, maxGuests: 5, extraCharge: 15000 },
            'Forest mini íŒ¨ë°€ë¦¬ë£¸': { basePrice: 150000, baseGuests: 2, maxGuests: 3, extraCharge: 15000 }
        };
        const BBQ_PRICE = 30000;

        // --- GLOBAL VARIABLES ---
        let allReservations = [];
        let currentEditData = null; 
        let autoRefreshInterval = null;
        let sessionPassword = null;
        let calendar = null;
        let isCalendarRendered = false;

        // --- API COMMUNICATION (JSONP) ---
        function apiRequest(params) {
            return new Promise((resolve, reject) => {
                if (!sessionPassword) { alert('ì¸ì¦ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'); logout(); reject(new Error('No session password.')); return; }
                const callbackName = 'jsonpCallback_' + Date.now() + Math.floor(Math.random() * 1000);
                params.password = sessionPassword;
                params.callback = callbackName;
                const queryString = Object.keys(params).map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join('&');
                
                window[callbackName] = function(data) {
                    if (data.success) { resolve(data); } else { console.error('API Error:', data.error); reject(new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜')); }
                    try { delete window[callbackName]; document.body.removeChild(script); } catch (e) {}
                };
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?${queryString}`;
                script.onerror = () => { reject(new Error('Script loading failed.')); try { delete window[callbackName]; document.body.removeChild(script); } catch (e) {} };
                document.body.appendChild(script);
            });
        }

        // --- AUTHENTICATION ---
        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (!password) { alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            showLoading();
            try {
                const response = await apiRequest({ action: 'checkPassword', password: password });
                if (response.success) {
                    sessionPassword = password;
                    sessionStorage.setItem('chohoAdminToken', password);
                    showDashboard();
                } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
            } catch(error) { alert(`ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
        }
        function logout() { sessionPassword = null; sessionStorage.removeItem('chohoAdminToken'); location.reload(); }
        function showDashboard() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; loadInitialData(); startAutoRefresh(); }
        
        // --- UTILITY ---
        function sanitizeHTML(str) { if (!str) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function formatDate(dateStr) { if (!dateStr) return ''; const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()} (${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]})`; }
        function getStatusText(s) { return { pending: 'ì…ê¸ˆëŒ€ê¸°', confirmed: 'ì˜ˆì•½í™•ì •', 'checked-in': 'ì²´í¬ì¸', cancelled: 'ì·¨ì†Œ' }[s] || 'ì•Œ ìˆ˜ ì—†ìŒ'; }
        
        // --- DATA HANDLING ---
        async function loadInitialData() {
            showLoading();
            try {
                await Promise.all([loadReservations(), updateDashboard()]);
                const now = new Date(); document.getElementById('lastSync').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                if (isCalendarRendered) renderCalendar(); // ìº˜ë¦°ë”ê°€ ë Œë”ë§ëœ ìƒíƒœë©´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            } catch (error) { alert(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
        }
        async function loadReservations() {
            const result = await apiRequest({ action: 'getReservations' });
            if (result.success) { allReservations = result.data; displayReservations(); updateRoomStatus(); }
        }
        async function updateDashboard() {
            const result = await apiRequest({ action: 'getDashboardStats' });
            if (result.success) {
                const s = result.data;
                document.getElementById('totalReservations').textContent = s.totalReservations;
                document.getElementById('confirmedReservations').textContent = s.confirmedReservations;
                document.getElementById('todayCheckIn').textContent = s.todayCheckIn;
                document.getElementById('monthlyRevenue').textContent = s.monthlyRevenue.toLocaleString() + 'ì›';
                const badge = document.getElementById('pendingBadge');
                if (s.pendingReservations > 0) { badge.textContent = s.pendingReservations; badge.style.display = 'block'; } else { badge.style.display = 'none'; }
            }
        }

        // --- UI & DISPLAY ---
        function displayReservations() {
            const container = document.getElementById('reservationsList');
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allReservations.filter(r => (statusFilter === 'all' || r.status === statusFilter) && ((r.customerName||'').toLowerCase().includes(searchTerm) || (r.phone||'').includes(searchTerm)));
            
            if (filtered.length === 0) { container.innerHTML = `<div class="no-reservations"><h3>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</h3><p>í•„í„° ì¡°ê±´ì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆ ì˜ˆì•½ì„ ì¶”ê°€í•˜ì„¸ìš”.</p></div>`; return; }

            container.innerHTML = filtered.map(res => `
                <div class="reservation-card" onclick="editReservation('${res.bookingId || res.id}')">
                    <div class="reservation-header">
                        <span style="font-weight:600;">#${sanitizeHTML(res.bookingId || res.id)}</span>
                        <span class="status-badge status-${res.status}">${getStatusText(res.status)}</span>
                    </div>
                    <div class="reservation-body">
                        <div class="customer-info"><div class="customer-name">${sanitizeHTML(res.customerName)}</div><div class="customer-contact">ğŸ“ ${sanitizeHTML(res.phone)}</div></div>
                        <div class="reservation-details">
                            <div class="detail-item"><div class="detail-label">ì²´í¬ì¸</div><div class="detail-value">${formatDate(res.checkIn)}</div></div>
                            <div class="detail-item"><div class="detail-label">ì²´í¬ì•„ì›ƒ</div><div class="detail-value">${formatDate(res.checkOut)}</div></div>
                            <div class="detail-item"><div class="detail-label">ê°ì‹¤</div><div class="detail-value">${sanitizeHTML(res.roomName)}</div></div>
                            <div class="detail-item"><div class="detail-label">ì¸ì›</div><div class="detail-value">${res.guests}ëª…</div></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function updateRoomStatus() { /* ì´ì „ ì½”ë“œì™€ ë™ì¼, ìƒëµ ê°€ëŠ¥ */ }
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            const events = allReservations.filter(r => r.status !== 'cancelled').map(r => ({
                title: `${r.roomName.replace('ê°ì‹¤','').replace('íŒ¨ë°€ë¦¬ë£¸','F')} - ${r.customerName}`,
                start: r.checkIn,
                end: r.checkOut,
                extendedProps: { reservation: r },
                backgroundColor: r.status === 'confirmed' ? '#27ae60' : (r.status === 'checked-in' ? '#3498db' : '#f39c12'),
            }));
            if (calendar) { calendar.destroy(); }
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                events: events,
                eventClick: function(info) { editReservation(info.event.extendedProps.reservation.bookingId || info.event.extendedProps.reservation.id); }
            });
            calendar.render();
            isCalendarRendered = true;
        }

        // --- ACTIONS & EVENT HANDLERS ---
        function startAutoRefresh() { if (autoRefreshInterval) clearInterval(autoRefreshInterval); autoRefreshInterval = setInterval(loadInitialData, 30000); }
        async function updateReservationAction(rowIndex, updates, successMsg) {
            showLoading();
            try {
                await apiRequest({ action: 'updateReservation', rowIndex: rowIndex, updates: JSON.stringify(updates) });
                alert(successMsg);
                await loadInitialData();
            } catch (error) { alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
        }
        function confirmDeposit(id, rowIndex) { if (confirm('ì…ê¸ˆì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?')) updateReservationAction(rowIndex, { depositConfirmed: true }, 'ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        function updateReservationStatus(id, rowIndex, status, msg) { if (confirm(msg)) updateReservationAction(rowIndex, { status }, 'ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); }

        async function saveReservation() {
            const formData = {
                customerName: document.getElementById('formCustomerName').value, phone: document.getElementById('formPhone').value, email: document.getElementById('formEmail').value,
                checkIn: document.getElementById('formCheckIn').value, checkOut: document.getElementById('formCheckOut').value, roomName: document.getElementById('formRoomType').value,
                guests: parseInt(document.getElementById('formGuests').value), requests: document.getElementById('formRequests').value,
                totalAmount: parseInt(document.getElementById('formAmount').value), bbqCharge: parseInt(document.getElementById('formBbqCharge').value) || 0,
                status: 'confirmed', depositConfirmed: true
            };
            if (!formData.customerName || !formData.phone || !formData.checkIn || !formData.checkOut) { alert('í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            showLoading();
            try {
                if (currentEditData) { await apiRequest({ action: 'updateReservation', rowIndex: currentEditData.rowIndex, updates: JSON.stringify(formData) }); alert('ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); } 
                else { await apiRequest({ action: 'addReservation', data: JSON.stringify(formData) }); alert('ì˜ˆì•½ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
                closeModal(); await loadInitialData();
            } catch (error) { alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { hideLoading(); }
        }

        // --- MODAL & FORM ---
        function showAddReservationModal() { currentEditData = null; document.getElementById('modalTitle').textContent = 'ìƒˆ ì˜ˆì•½ ì¶”ê°€'; document.getElementById('reservationForm').reset(); updatePriceSummary(); document.getElementById('reservationModal').classList.add('active'); }
        function editReservation(id) {
            const reservation = allReservations.find(r => (r.bookingId || r.id) === id); if (!reservation) { alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            currentEditData = reservation; document.getElementById('modalTitle').textContent = 'ì˜ˆì•½ ì •ë³´ ìˆ˜ì •';
            populateGuestOptions(reservation.roomName);
            document.getElementById('formCustomerName').value = reservation.customerName; document.getElementById('formPhone').value = reservation.phone; document.getElementById('formEmail').value = reservation.email || '';
            document.getElementById('formCheckIn').value = reservation.checkIn; document.getElementById('formCheckOut').value = reservation.checkOut;
            document.getElementById('formRoomType').value = reservation.roomName; document.getElementById('formGuests').value = reservation.guests;
            document.getElementById('formBbq').checked = (reservation.bbqCharge > 0); document.getElementById('formRequests').value = reservation.requests || '';
            updatePriceSummary(); document.getElementById('reservationModal').classList.add('active');
        }
        function closeModal() { document.getElementById('reservationModal').classList.remove('active'); }
        function updatePriceSummary() {
            const roomName = document.getElementById('formRoomType').value;
            const checkIn = document.getElementById('formCheckIn').value;
            const checkOut = document.getElementById('formCheckOut').value;
            const guests = parseInt(document.getElementById('formGuests').value || 0);
            const bbqChecked = document.getElementById('formBbq').checked;
            const room = roomData[roomName];
            if (!room || !checkIn || !checkOut) return;

            const nights = Math.max(1, Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24)));
            const roomRate = room.basePrice * nights;
            const extraGuests = Math.max(0, guests - room.baseGuests);
            const extraPersonCharge = extraGuests * room.extraCharge * nights;
            const bbqCharge = bbqChecked ? BBQ_PRICE : 0;
            const totalAmount = roomRate + extraPersonCharge;

            document.getElementById('summaryRoomRate').textContent = `${roomRate.toLocaleString()}ì› (${nights}ë°•)`;
            document.getElementById('summaryExtraPerson').textContent = `${extraPersonCharge.toLocaleString()}ì› (${extraGuests}ëª…)`;
            document.getElementById('summaryBbq').textContent = `${bbqCharge.toLocaleString()}ì› (í˜„ì¥ê²°ì œ)`;
            document.getElementById('summaryTotal').textContent = `${totalAmount.toLocaleString()}ì›`;
            document.getElementById('formAmount').value = totalAmount;
            document.getElementById('formBbqCharge').value = bbqCharge;
        }
        function populateGuestOptions(roomName) {
            const room = roomData[roomName]; if(!room) return;
            const guestSelect = document.getElementById('formGuests');
            guestSelect.innerHTML = '';
            for (let i = 1; i <= room.maxGuests; i++) {
                const option = document.createElement('option');
                option.value = i; option.textContent = `${i}ëª…`;
                guestSelect.appendChild(option);
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('passwordInput').addEventListener('keyup', e => { if (e.key === 'Enter') login(); });
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('addReservationButton').addEventListener('click', showAddReservationModal);
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            document.getElementById('cancelModalButton').addEventListener('click', closeModal);
            document.getElementById('saveReservationButton').addEventListener('click', saveReservation);
            document.getElementById('statusFilter').addEventListener('change', displayReservations);
            document.getElementById('searchInput').addEventListener('keyup', displayReservations);
            
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', e => {
                document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                const tabName = e.currentTarget.dataset.tab;
                e.currentTarget.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
                if (tabName === 'calendar' && !isCalendarRendered) renderCalendar();
            }));

            ['formCheckIn', 'formCheckOut', 'formRoomType', 'formGuests', 'formBbq'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePriceSummary);
            });
            document.getElementById('formRoomType').addEventListener('change', e => populateGuestOptions(e.target.value));
            populateGuestOptions(document.getElementById('formRoomType').value);

            if (sessionStorage.getItem('chohoAdminToken')) { sessionPassword = sessionStorage.getItem('chohoAdminToken'); showDashboard(); }
        });
    </script>
</body>
</html>
