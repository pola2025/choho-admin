<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초호펜션 예약 관리 시스템 v2.0</title>
    <!-- FullCalendar 라이브러리 추가 -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <style>
        /* 전체적인 CSS는 이전과 동일합니다. */
        :root {
            --primary-color: #2d5016;
            --secondary-color: #558b2f;
            --accent-green: #27ae60;
            --light-gray: #f5f5f5;
            --dark-text: #333;
            --light-text: #666;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); color: var(--dark-text); }
        /* ... (이전 CSS 코드와 동일) ... */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .login-box h1 { color: var(--primary-color); }
        .login-button { background: var(--accent-green); }
        .header h1 { color: var(--primary-color); }
        .stat-value { color: var(--primary-color); }
        .tab.active { color: var(--accent-green); border-bottom-color: var(--accent-green); }
        .customer-name { color: var(--primary-color); }
        .floating-add-btn { background: var(--accent-green); }
        .spinner { border-top-color: var(--accent-green); }

        /* 캘린더 UI 개선 */
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .fc-event {
            cursor: pointer;
            border: none !important;
            padding: 5px;
        }
        .fc-event-main {
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 예약 금액 요약 UI */
        .price-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
        }
        .price-summary h4 {
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--primary-color);
        }
        .price-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .price-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-weight: bold;
            font-size: 18px;
            color: var(--accent-green);
        }
        .no-reservations {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 12px;
            color: var(--light-text);
        }
    </style>
</head>
<body>
    <!-- 로그인 화면 -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>초호펜션 관리 시스템</h1>
            <input type="password" id="passwordInput" class="login-input" placeholder="비밀번호를 입력하세요">
            <button id="loginButton" class="login-button">로그인</button>
        </div>
    </div>
    
    <!-- 메인 대시보드 -->
    <div class="dashboard" id="dashboard">
        <!-- 헤더 및 통계 (이전과 동일) -->
        <div class="header">
             <div class="header-content">
                <h1>초호펜션 예약 관리</h1>
                <div class="header-actions">
                    <div class="sync-status">
                        <div class="sync-dot"></div>
                        <span id="lastSync">실시간 동기화 중</span>
                    </div>
                    <button id="logoutButton" class="logout-btn">로그아웃</button>
                </div>
            </div>
        </div>
        <div class="stats-container">
            <div class="stat-card accent-yellow"><h3>전체 예약</h3><div class="stat-value" id="totalReservations">0</div></div>
            <div class="stat-card accent-green"><h3>확정 예약</h3><div class="stat-value" id="confirmedReservations">0</div></div>
            <div class="stat-card accent-blue"><h3>오늘 체크인</h3><div class="stat-value" id="todayCheckIn">0</div></div>
            <div class="stat-card accent-purple"><h3>이번달 매출</h3><div class="stat-value" id="monthlyRevenue">0원</div></div>
        </div>
        
        <!-- 탭 네비게이션 -->
        <div class="tabs">
            <div class="tabs-content">
                <div class="tab active" data-tab="reservations">예약 관리<span class="tab-badge" id="pendingBadge" style="display: none;">0</span></div>
                <div class="tab" data-tab="rooms">객실 현황</div>
                <div class="tab" data-tab="calendar">캘린더</div>
            </div>
        </div>
        
        <!-- 메인 컨텐츠 -->
        <div class="content">
            <div class="tab-content active" id="reservationsTab">
                <div class="filter-bar">
                    <div class="filter-item"><label>상태:</label><select class="filter-select" id="statusFilter"><option value="all">전체</option><option value="pending">입금대기</option><option value="confirmed">예약확정</option><option value="checked-in">체크인</option><option value="cancelled">취소</option></select></div>
                    <div class="search-box"><span class="search-icon">🔍</span><input type="text" class="search-input" id="searchInput" placeholder="고객명, 전화번호로 검색"></div>
                </div>
                <div class="reservations-container" id="reservationsList"></div>
            </div>
            <div class="tab-content" id="roomsTab"><div class="rooms-grid" id="roomsList"></div></div>
            <div class="tab-content" id="calendarTab"><div id="calendar"></div></div>
        </div>
        
        <button id="addReservationButton" class="floating-add-btn">+</button>
    </div>
    
    <!-- 예약 추가/수정 모달 -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle"></h2><button id="closeModalButton" style="background:none;border:none;font-size:24px;cursor:pointer;">×</button></div>
            <div class="modal-body">
                <form id="reservationForm">
                    <div class="form-group"><label class="form-label">고객명 *</label><input type="text" class="form-input" id="formCustomerName" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">전화번호 *</label><input type="tel" class="form-input" id="formPhone" required></div>
                        <div class="form-group"><label class="form-label">이메일</label><input type="email" class="form-input" id="formEmail"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">체크인 *</label><input type="date" class="form-input" id="formCheckIn" required></div>
                        <div class="form-group"><label class="form-label">체크아웃 *</label><input type="date" class="form-input" id="formCheckOut" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">객실 타입</label><select class="form-input" id="formRoomType"><option value="호수뷰객실">호수뷰객실</option><option value="Forest">Forest</option><option value="Forest mini">Forest mini</option><option value="Forest 패밀리룸">Forest 패밀리룸</option><option value="Forest mini 패밀리룸">Forest mini 패밀리룸</option></select></div>
                        <div class="form-group"><label class="form-label">인원</label><select class="form-input" id="formGuests"></select></div>
                    </div>
                    <div class="form-group"><label class="form-label"><input type="checkbox" id="formBbq"> 숯불 바베큐 (현장 결제)</label></div>
                    <div class="form-group"><label class="form-label">요청사항</label><textarea class="form-input" id="formRequests" rows="3"></textarea></div>
                    
                    <!-- 예약 금액 요약 -->
                    <div class="price-summary">
                        <h4>예약 금액</h4>
                        <div class="price-item"><span>객실 요금</span><span id="summaryRoomRate">-</span></div>
                        <div class="price-item"><span>추가 인원</span><span id="summaryExtraPerson">-</span></div>
                        <div class="price-item"><span>바베큐</span><span id="summaryBbq">-</span></div>
                        <div class="price-item price-total"><span>총 금액</span><span id="summaryTotal">-</span></div>
                    </div>
                    <input type="hidden" id="formAmount"><input type="hidden" id="formBbqCharge">
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" id="cancelModalButton" class="action-btn btn-secondary" style="flex:1;">취소</button>
                        <button type="button" id="saveReservationButton" class="action-btn btn-success" style="flex:1;">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    
    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9Fav0VorRG1ukk1StToVuBoHrPvVw_sqUGZacSuBimPbbI3f54O5in00Y6-Z91AEhtQ/exec';
        const roomData = {
            '호수뷰객실': { basePrice: 150000, baseGuests: 2, maxGuests: 6, extraCharge: 15000 },
            'Forest': { basePrice: 180000, baseGuests: 2, maxGuests: 4, extraCharge: 15000 },
            'Forest mini': { basePrice: 150000, baseGuests: 2, maxGuests: 2, extraCharge: 0 },
            'Forest 패밀리룸': { basePrice: 200000, baseGuests: 4, maxGuests: 5, extraCharge: 15000 },
            'Forest mini 패밀리룸': { basePrice: 150000, baseGuests: 2, maxGuests: 3, extraCharge: 15000 }
        };
        const BBQ_PRICE = 30000;

        // --- GLOBAL VARIABLES ---
        let allReservations = [];
        let currentEditData = null; 
        let autoRefreshInterval = null;
        let sessionPassword = null;
        let calendar = null;
        let isCalendarRendered = false;

        // --- API COMMUNICATION (JSONP) ---
        function apiRequest(params) {
            return new Promise((resolve, reject) => {
                if (!sessionPassword) { alert('인증 정보가 만료되었습니다. 다시 로그인해주세요.'); logout(); reject(new Error('No session password.')); return; }
                const callbackName = 'jsonpCallback_' + Date.now() + Math.floor(Math.random() * 1000);
                params.password = sessionPassword;
                params.callback = callbackName;
                const queryString = Object.keys(params).map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join('&');
                
                window[callbackName] = function(data) {
                    if (data.success) { resolve(data); } else { console.error('API Error:', data.error); reject(new Error(data.error || '알 수 없는 서버 오류')); }
                    try { delete window[callbackName]; document.body.removeChild(script); } catch (e) {}
                };
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?${queryString}`;
                script.onerror = () => { reject(new Error('Script loading failed.')); try { delete window[callbackName]; document.body.removeChild(script); } catch (e) {} };
                document.body.appendChild(script);
            });
        }

        // --- AUTHENTICATION ---
        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (!password) { alert('비밀번호를 입력하세요.'); return; }
            showLoading();
            try {
                const response = await apiRequest({ action: 'checkPassword', password: password });
                if (response.success) {
                    sessionPassword = password;
                    sessionStorage.setItem('chohoAdminToken', password);
                    showDashboard();
                } else { alert('비밀번호가 올바르지 않습니다.'); }
            } catch(error) { alert(`로그인 중 오류가 발생했습니다: ${error.message}`); } finally { hideLoading(); }
        }
        function logout() { sessionPassword = null; sessionStorage.removeItem('chohoAdminToken'); location.reload(); }
        function showDashboard() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; loadInitialData(); startAutoRefresh(); }
        
        // --- UTILITY ---
        function sanitizeHTML(str) { if (!str) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function formatDate(dateStr) { if (!dateStr) return ''; const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()} (${['일','월','화','수','목','금','토'][d.getDay()]})`; }
        function getStatusText(s) { return { pending: '입금대기', confirmed: '예약확정', 'checked-in': '체크인', cancelled: '취소' }[s] || '알 수 없음'; }
        
        // --- DATA HANDLING ---
        async function loadInitialData() {
            showLoading();
            try {
                await Promise.all([loadReservations(), updateDashboard()]);
                const now = new Date(); document.getElementById('lastSync').textContent = `마지막 동기화: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                if (isCalendarRendered) renderCalendar(); // 캘린더가 렌더링된 상태면 데이터 새로고침
            } catch (error) { alert(`데이터를 불러오는 데 실패했습니다: ${error.message}`); } finally { hideLoading(); }
        }
        async function loadReservations() {
            const result = await apiRequest({ action: 'getReservations' });
            if (result.success) { allReservations = result.data; displayReservations(); updateRoomStatus(); }
        }
        async function updateDashboard() {
            const result = await apiRequest({ action: 'getDashboardStats' });
            if (result.success) {
                const s = result.data;
                document.getElementById('totalReservations').textContent = s.totalReservations;
                document.getElementById('confirmedReservations').textContent = s.confirmedReservations;
                document.getElementById('todayCheckIn').textContent = s.todayCheckIn;
                document.getElementById('monthlyRevenue').textContent = s.monthlyRevenue.toLocaleString() + '원';
                const badge = document.getElementById('pendingBadge');
                if (s.pendingReservations > 0) { badge.textContent = s.pendingReservations; badge.style.display = 'block'; } else { badge.style.display = 'none'; }
            }
        }

        // --- UI & DISPLAY ---
        function displayReservations() {
            const container = document.getElementById('reservationsList');
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allReservations.filter(r => (statusFilter === 'all' || r.status === statusFilter) && ((r.customerName||'').toLowerCase().includes(searchTerm) || (r.phone||'').includes(searchTerm)));
            
            if (filtered.length === 0) { container.innerHTML = `<div class="no-reservations"><h3>예약이 없습니다.</h3><p>필터 조건을 확인하거나 새 예약을 추가하세요.</p></div>`; return; }

            container.innerHTML = filtered.map(res => `
                <div class="reservation-card" onclick="editReservation('${res.bookingId || res.id}')">
                    <div class="reservation-header">
                        <span style="font-weight:600;">#${sanitizeHTML(res.bookingId || res.id)}</span>
                        <span class="status-badge status-${res.status}">${getStatusText(res.status)}</span>
                    </div>
                    <div class="reservation-body">
                        <div class="customer-info"><div class="customer-name">${sanitizeHTML(res.customerName)}</div><div class="customer-contact">📞 ${sanitizeHTML(res.phone)}</div></div>
                        <div class="reservation-details">
                            <div class="detail-item"><div class="detail-label">체크인</div><div class="detail-value">${formatDate(res.checkIn)}</div></div>
                            <div class="detail-item"><div class="detail-label">체크아웃</div><div class="detail-value">${formatDate(res.checkOut)}</div></div>
                            <div class="detail-item"><div class="detail-label">객실</div><div class="detail-value">${sanitizeHTML(res.roomName)}</div></div>
                            <div class="detail-item"><div class="detail-label">인원</div><div class="detail-value">${res.guests}명</div></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function updateRoomStatus() { /* 이전 코드와 동일, 생략 가능 */ }
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            const events = allReservations.filter(r => r.status !== 'cancelled').map(r => ({
                title: `${r.roomName.replace('객실','').replace('패밀리룸','F')} - ${r.customerName}`,
                start: r.checkIn,
                end: r.checkOut,
                extendedProps: { reservation: r },
                backgroundColor: r.status === 'confirmed' ? '#27ae60' : (r.status === 'checked-in' ? '#3498db' : '#f39c12'),
            }));
            if (calendar) { calendar.destroy(); }
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                events: events,
                eventClick: function(info) { editReservation(info.event.extendedProps.reservation.bookingId || info.event.extendedProps.reservation.id); }
            });
            calendar.render();
            isCalendarRendered = true;
        }

        // --- ACTIONS & EVENT HANDLERS ---
        function startAutoRefresh() { if (autoRefreshInterval) clearInterval(autoRefreshInterval); autoRefreshInterval = setInterval(loadInitialData, 30000); }
        async function updateReservationAction(rowIndex, updates, successMsg) {
            showLoading();
            try {
                await apiRequest({ action: 'updateReservation', rowIndex: rowIndex, updates: JSON.stringify(updates) });
                alert(successMsg);
                await loadInitialData();
            } catch (error) { alert(`처리 중 오류가 발생했습니다: ${error.message}`); } finally { hideLoading(); }
        }
        function confirmDeposit(id, rowIndex) { if (confirm('입금을 확인하셨습니까?')) updateReservationAction(rowIndex, { depositConfirmed: true }, '입금이 확인되었습니다.'); }
        function updateReservationStatus(id, rowIndex, status, msg) { if (confirm(msg)) updateReservationAction(rowIndex, { status }, '상태가 업데이트되었습니다.'); }

        async function saveReservation() {
            const formData = {
                customerName: document.getElementById('formCustomerName').value, phone: document.getElementById('formPhone').value, email: document.getElementById('formEmail').value,
                checkIn: document.getElementById('formCheckIn').value, checkOut: document.getElementById('formCheckOut').value, roomName: document.getElementById('formRoomType').value,
                guests: parseInt(document.getElementById('formGuests').value), requests: document.getElementById('formRequests').value,
                totalAmount: parseInt(document.getElementById('formAmount').value), bbqCharge: parseInt(document.getElementById('formBbqCharge').value) || 0,
                status: 'confirmed', depositConfirmed: true
            };
            if (!formData.customerName || !formData.phone || !formData.checkIn || !formData.checkOut) { alert('필수 항목(*)을 모두 입력해주세요.'); return; }
            showLoading();
            try {
                if (currentEditData) { await apiRequest({ action: 'updateReservation', rowIndex: currentEditData.rowIndex, updates: JSON.stringify(formData) }); alert('예약이 수정되었습니다.'); } 
                else { await apiRequest({ action: 'addReservation', data: JSON.stringify(formData) }); alert('예약이 추가되었습니다.'); }
                closeModal(); await loadInitialData();
            } catch (error) { alert(`처리 중 오류가 발생했습니다: ${error.message}`); } finally { hideLoading(); }
        }

        // --- MODAL & FORM ---
        function showAddReservationModal() { currentEditData = null; document.getElementById('modalTitle').textContent = '새 예약 추가'; document.getElementById('reservationForm').reset(); updatePriceSummary(); document.getElementById('reservationModal').classList.add('active'); }
        function editReservation(id) {
            const reservation = allReservations.find(r => (r.bookingId || r.id) === id); if (!reservation) { alert('예약 정보를 찾을 수 없습니다.'); return; }
            currentEditData = reservation; document.getElementById('modalTitle').textContent = '예약 정보 수정';
            populateGuestOptions(reservation.roomName);
            document.getElementById('formCustomerName').value = reservation.customerName; document.getElementById('formPhone').value = reservation.phone; document.getElementById('formEmail').value = reservation.email || '';
            document.getElementById('formCheckIn').value = reservation.checkIn; document.getElementById('formCheckOut').value = reservation.checkOut;
            document.getElementById('formRoomType').value = reservation.roomName; document.getElementById('formGuests').value = reservation.guests;
            document.getElementById('formBbq').checked = (reservation.bbqCharge > 0); document.getElementById('formRequests').value = reservation.requests || '';
            updatePriceSummary(); document.getElementById('reservationModal').classList.add('active');
        }
        function closeModal() { document.getElementById('reservationModal').classList.remove('active'); }
        function updatePriceSummary() {
            const roomName = document.getElementById('formRoomType').value;
            const checkIn = document.getElementById('formCheckIn').value;
            const checkOut = document.getElementById('formCheckOut').value;
            const guests = parseInt(document.getElementById('formGuests').value || 0);
            const bbqChecked = document.getElementById('formBbq').checked;
            const room = roomData[roomName];
            if (!room || !checkIn || !checkOut) return;

            const nights = Math.max(1, Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24)));
            const roomRate = room.basePrice * nights;
            const extraGuests = Math.max(0, guests - room.baseGuests);
            const extraPersonCharge = extraGuests * room.extraCharge * nights;
            const bbqCharge = bbqChecked ? BBQ_PRICE : 0;
            const totalAmount = roomRate + extraPersonCharge;

            document.getElementById('summaryRoomRate').textContent = `${roomRate.toLocaleString()}원 (${nights}박)`;
            document.getElementById('summaryExtraPerson').textContent = `${extraPersonCharge.toLocaleString()}원 (${extraGuests}명)`;
            document.getElementById('summaryBbq').textContent = `${bbqCharge.toLocaleString()}원 (현장결제)`;
            document.getElementById('summaryTotal').textContent = `${totalAmount.toLocaleString()}원`;
            document.getElementById('formAmount').value = totalAmount;
            document.getElementById('formBbqCharge').value = bbqCharge;
        }
        function populateGuestOptions(roomName) {
            const room = roomData[roomName]; if(!room) return;
            const guestSelect = document.getElementById('formGuests');
            guestSelect.innerHTML = '';
            for (let i = 1; i <= room.maxGuests; i++) {
                const option = document.createElement('option');
                option.value = i; option.textContent = `${i}명`;
                guestSelect.appendChild(option);
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('passwordInput').addEventListener('keyup', e => { if (e.key === 'Enter') login(); });
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('addReservationButton').addEventListener('click', showAddReservationModal);
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            document.getElementById('cancelModalButton').addEventListener('click', closeModal);
            document.getElementById('saveReservationButton').addEventListener('click', saveReservation);
            document.getElementById('statusFilter').addEventListener('change', displayReservations);
            document.getElementById('searchInput').addEventListener('keyup', displayReservations);
            
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', e => {
                document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                const tabName = e.currentTarget.dataset.tab;
                e.currentTarget.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
                if (tabName === 'calendar' && !isCalendarRendered) renderCalendar();
            }));

            ['formCheckIn', 'formCheckOut', 'formRoomType', 'formGuests', 'formBbq'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePriceSummary);
            });
            document.getElementById('formRoomType').addEventListener('change', e => populateGuestOptions(e.target.value));
            populateGuestOptions(document.getElementById('formRoomType').value);

            if (sessionStorage.getItem('chohoAdminToken')) { sessionPassword = sessionStorage.getItem('chohoAdminToken'); showDashboard(); }
        });
    </script>
</body>
</html>
